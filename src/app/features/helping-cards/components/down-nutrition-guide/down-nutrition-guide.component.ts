import { CommonModule } from '@angular/common';
import { Component, computed, signal } from '@angular/core';

type UiBlock = {
  title?: string;
  desc?: string;
  points?: string[];
};

type MealDay = {
  title: string;
  subtitle?: string;
  meals: { time: string; text: string }[];
  quickTips?: string[];
};

@Component({
  selector: 'app-down-nutrition-guide',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './down-nutrition-guide.component.html',
})
export class DownNutritionGuideComponent {
  // UI texts
  heading = 'دليل التغذية المبسّط لمتلازمة داون';
  sub =
    'نظام عملي للحفاظ على وزن صحي وتقليل الإمساك ودعم النمو — مع مراعاة الحالات المصاحبة مثل الغدة الدرقية أو القلب.';

  heroBadges: string[] = [
    'وزن صحي',
    'ألياف وماء',
    'بروتين جيد',
    'دهون صحية',
    'وجبات منظمة',
  ];

  // search
  search = signal<string>('');
  q = computed(() => (this.search() || '').trim().toLowerCase());

  // ---------- Section 1: مقدمة ----------
  introBlocks: UiBlock[] = [
    {
      title: 'الفكرة الأساسية',
      desc:
        'النظام الغذائي المناسب لأطفال ومتلازمة داون يركّز على الصحة العامة، وزن صحي، وتقليل مشاكل شائعة مثل الإمساك وزيادة الوزن بسبب بطء الأيض، مع مراعاة صعوبات الأكل أو الحساسية المحتملة.',
      points: [
        'النظام قريب من الإرشادات العامة لكنه أكثر تنظيمًا.',
        'وجبات صغيرة متكررة تفيد كثيرًا.',
        'يفضل تخصيص الخطة حسب حالة الغدة الدرقية/الهضم/القلب.',
      ],
    },
    {
      title: 'مهم جدًا',
      desc: 'هذه معلومات تثقيفية ولا تغني عن المتابعة مع طبيب/أخصائي تغذية.',
      points: [
        'تابعي الوزن والنمو دوريًا.',
        'لو في سيلياك/حساسية جلوتين → نظام خالٍ من الجلوتين.',
        'المكملات (Vitamin D مثلًا) تحت إشراف طبي فقط.',
      ],
    },
  ];

  // ---------- Section 2: حسب العمر ----------
  ageStages: UiBlock[] = [
    {
      title: 'من سنة إلى 4 سنوات',
      desc:
        'الهدف دعم النمو والتطور مع التعامل مع صعوبة البلع/بطء تقبل الأطعمة الجديدة.',
      points: [
        '3 وجبات رئيسية + 1–2 سناك (بدون إفراط).',
        'فواكه وخضار طازجة + حبوب كاملة + بروتينات هزيلة + ألبان قليلة الدسم.',
        'ماء طوال اليوم، وتجنّبي العصائر السكرية لتفادي الإمساك وزيادة الوزن.',
        'اعملي روتين ثابت للأكل وشجعي الاستكشاف.',
      ],
    },
    {
      title: 'من 5 إلى 12 سنة',
      desc:
        'يزداد خطر الوزن الزائد بسبب انخفاض معدل الأيض؛ ركّزي على التنوع والنشاط.',
      points: [
        '3 وجبات رئيسية + 2 سناك كل ~3 ساعات (وتقليل الأكل خارج الأوقات).',
        'نصف الطبق خضار/فاكهة + حبوب كاملة + بروتين + ألبان قليلة الدسم.',
        'زيدي الألياف والماء لمحاربة الإمساك.',
        'قللي السكريات والدهون المشبعة.',
      ],
    },
    {
      title: 'من 13 سنة إلى البالغين',
      desc:
        'الحفاظ على وزن صحي ومنع أمراض مزمنة مثل السكري/القلب مع نشاط يومي.',
      points: [
        'وجبات متوازنة حسب النشاط (عجز طاقي بسيط لو في زيادة وزن).',
        'فواكه/خضار/حبوب كاملة/بروتينات هزيلة/ألبان قليلة الدسم.',
        'ألياف + ماء للإمساك.',
        'تركيز على الكالسيوم للعظام وأوميغا-3 للصحة العصبية.',
      ],
    },
  ];

  // ---------- Section 3: نصائح عامة ----------
  generalTips: UiBlock[] = [
    {
      title: 'الترطيب',
      desc: 'شرب الماء بانتظام يقلّل الإمساك ويساعد تنظيم الشهية.',
      points: ['زجاجة ماء قريبة دائمًا', 'ماء قبل السناك', 'شوربة وخضار مرطبة'],
    },
    {
      title: 'تجنّبي قدر الإمكان',
      desc: 'أشياء ترفع الوزن وتزيد الالتهاب والإمساك.',
      points: ['سكريات زائدة', 'مقليات', 'دهون مشبعة', 'مشروبات غازية'],
    },
    {
      title: 'مراقبة دورية',
      desc: 'فحوصات نمو وعناصر غذائية مهمة جدًا.',
      points: [
        'الوزن والطول',
        'Vitamin D / B12 حسب الطبيب',
        'الحديد',
        'الغدة الدرقية',
      ],
    },
    {
      title: 'عادات مبكرة',
      desc: 'ابدئي مبكرًا لتجنّبي مشكلات طويلة المدى.',
      points: ['الوجبات العائلية', 'طبق متوازن', 'سناك صحي ثابت'],
    },
  ];

  // ---------- Section 4: لو في عيوب قلب خلقية ----------
  heartIntro: string[] = [
    'حوالي 40–50% من أطفال متلازمة داون قد يولدون بعيوب قلب خلقية.',
    'الطفل قد يتعب بسرعة أثناء الرضاعة/الأكل بسبب صعوبة التنفس أو التعرّق.',
    'قد يحتاج سعرات وبروتين أعلى لتحسين النمو خاصة قبل الجراحة.',
    'ومع ذلك، خطر زيادة الوزن لاحقًا يظل أعلى — فنوازن بذكاء.',
  ];

  heartWhy: string[] = [
    'يتعب بسرعة أثناء الأكل → يحتاج وجبات أصغر وأكثر تكرارًا.',
    'قد يحتاج سعرات أعلى للنمو واكتساب وزن جيد.',
    'مشاكل شائعة: ارتجاع/إمساك/صعوبة بلع.',
  ];

  heartCaloriesProtein: string[] = [
    'السعرات قد تصل إلى 110–150 سعرة/كجم يوميًا (أحيانًا أكثر قبل الجراحة) حسب الطبيب.',
    'زيادة البروتين (تقريبًا 2–3.5 جم/كجم يوميًا) لدعم النمو والعضلات.',
  ];

  heartHighCaloriesTips: string[] = [
    'زيادة السعرات بدون تكبير حجم الوجبة (مهم لأن الطفل يتعب سريعًا).',
    'أضيفي زيت زيتون/زبدة/كريمة بكميات صغيرة للطعام.',
    'استخدمي تركيبات عالية السعرات أو مكملات سعرية فقط بإشراف الطبيب.',
    'وجبات صغيرة متكررة كل 2–3 ساعات.',
  ];

  heartHealthyFoods: string[] = [
    'خضار وفواكه متنوعة يوميًا.',
    'حبوب كاملة: شوفان، أرز بني، خبز أسمر.',
    'بروتين صحي: سمك غني بأوميغا-3 (سلمون)، دجاج بدون جلد، بيض، بقوليات.',
    'دهون صحية: زيت زيتون، أفوكادو، مكسرات مطحونة للصغار.',
    'ألبان قليلة الدسم أو حسب توجيه الطبيب.',
  ];

  heartAvoid: string[] = [
    'سكريات مضافة وحلويات ومشروبات غازية.',
    'مقليات ودهون مشبعة زائدة.',
    'ملح زائد (خصوصًا في حالات احتباس سوائل/ضغط).',
    'أطعمة تزيد الارتجاع إذا موجود (حمضيات/شوكولاتة/حار).',
  ];

  heartNotes: string[] = [
    'Vitamin D + كالسيوم للعظام.',
    'أوميغا-3 (غذاء أو مكمل) بإرشاد طبي.',
    'مراقبة الغدة الدرقية.',
    'لو سيلياك/جلوتين → نظام خالٍ من الجلوتين.',
    'الخطة شخصية: طبيب قلب أطفال + أخصائي تغذية.',
  ];

  // ---------- Section 5: أمثلة وجبات (عيوب قلب خلقية) ----------
  mealDays: MealDay[] = [
    {
      title: 'مثال يومي 1',
      subtitle: 'تركيز على زيادة السعرات بسهولة',
      meals: [
        { time: 'الإفطار', text: 'شوفان بحليب كامل + موز مهروس + ملعقة زبدة فول سوداني + رشة قرفة + ملعقة صغيرة زيت/زبدة.' },
        { time: 'سناك 1', text: 'زبادي يوناني كامل + عسل قليل + مكسرات مطحونة + فاكهة.' },
        { time: 'الغداء', text: 'أرز مطبوخ بزيت زيتون + دجاج مفروم + خضار مهروسة + زيت زيتون فوقها.' },
        { time: 'سناك 2', text: 'سموذي: حليب + موز + أفوكادو + شوفان + عسل + (شيا لو يتقبل).' },
        { time: 'العشاء', text: 'بطاطس مهروسة بالحليب والزبدة + سلمون مشوي/تونة + خضار مطبوخة ناعمة.' },
        { time: 'قبل النوم', text: 'جبنة قريش/زبادي كامل + فاكهة + ملعقة زبدة لوز.' },
      ],
      quickTips: ['أضيفي 1–2 ملعقة زيت زيتون/زبدة لكل وجبة', 'قدّمي في أطباق صغيرة لتقليل التعب'],
    },
    {
      title: 'مثال يومي 2',
      subtitle: 'تركيز على البروتين وأوميغا-3',
      meals: [
        { time: 'الإفطار', text: 'بيض مهروس مع زبدة + خبز أسمر مع أفوكادو + شرائح موز.' },
        { time: 'سناك 1', text: 'تمر محشو بجوز + كوب حليب دافئ مع عسل قليل.' },
        { time: 'الغداء', text: 'مكرونة حبوب كاملة بزيت زيتون + صلصة منزلية + لحم مفروم/عدس + جبن.' },
        { time: 'سناك 2', text: 'عصير طبيعي مخفف + بسكويت شوفان منزلي مع زبدة.' },
        { time: 'العشاء', text: 'شوربة عدس/حمص مطحونة + دجاج/سمك + خبز أسمر + سلطة ناعمة بزيت زيتون.' },
        { time: 'قبل النوم', text: 'زبادي + فواكه مجففة + رشة قرفة.' },
      ],
    },
    {
      title: 'مثال يومي 3',
      subtitle: 'للأطفال الذين يفضلون الأطعمة الناعمة/المهروسة',
      meals: [
        { time: 'الإفطار', text: 'عصيدة شوفان/أرز بالحليب + موز مهروس + زبدة + قرفة.' },
        { time: 'سناك 1', text: 'أفوكادو مهروس مع خبز طري + شرائح تفاح.' },
        { time: 'الغداء', text: 'بطاطس حلوة مهروسة + دجاج مفروم + خضار مطبوخة + زيت زيتون.' },
        { time: 'سناك 2', text: 'حليب + سموذي فواكه + زبادي (أو مكمل سعري لو وصف الطبيب).' },
        { time: 'العشاء', text: 'سمك مهروس (سلمون/سردين) + أرز ناعم + خضار مطبوخة.' },
        { time: 'قبل النوم', text: 'جبنة + عسل قليل + فاكهة ناعمة.' },
      ],
    },
  ];

  // ---------- helpers ----------
  /**
   * Filter lists of blocks (objects: title/desc/points) by search.
   */
  filtered<T extends UiBlock>(list: T[]): T[] {
    const q = this.q();
    if (!q) return list;

    return list.filter((x) => {
      const blob = [x.title, x.desc, ...(x.points || [])]
        .filter(Boolean)
        .join(' ')
        .toLowerCase();
      return blob.includes(q);
    });
  }

  /**
   * ✅ Fix: Filter string arrays by search.
   * This replaces calling filtered() for string[].
   */
  filterTextList(list: string[]): string[] {
    const q = this.q();
    if (!q) return list;
    return list.filter((x) => (x || '').toLowerCase().includes(q));
  }

  trackByIndex = (i: number) => i;
}
