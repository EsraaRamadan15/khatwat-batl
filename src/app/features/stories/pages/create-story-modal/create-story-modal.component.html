<p-dialog
  [(visible)]="open"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  (onHide)="close()"
  [style]="{ width: 'min(920px, 96vw)' }"
  [contentStyle]="{ overflow: 'auto' }"
  dir="rtl"
  styleClass="rounded-3xl overflow-hidden"
>
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="flex items-start justify-between gap-4 w-full">
      <div>
        <h2 class="text-[18px] font-extrabold text-black m-0">إضافة قصة جديدة</h2>
        <p class="mt-1 text-[13px] font-bold text-stone-600">
          املئي البيانات الأساسية، ويمكن إضافة صور/فيديو/روابط في قسم الوسائط.
        </p>
      </div>


    </div>
  </ng-template>

  <!-- Body -->
  <form class="p-2 md:p-3" [formGroup]="form" (ngSubmit)="submit()">
    <!-- alerts -->
    <div
      *ngIf="errorMsg"
      class="mb-4 rounded-2xl border border-red-500/20 bg-red-50 px-4 py-3 text-[13px] font-bold text-red-700"
    >
      {{ errorMsg }}
    </div>

    <div
      *ngIf="successMsg"
      class="mb-4 rounded-2xl border border-emerald-500/20 bg-emerald-50 px-4 py-3 text-[13px] font-bold text-emerald-700"
    >
      {{ successMsg }}
    </div>

    <!-- grid -->
    <div class="grid gap-4 md:grid-cols-2">
      <!-- title -->
      <div class="md:col-span-2">
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">
          عنوان القصة <span class="text-red-600">*</span>
        </label>

        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="title"
          placeholder="مثال: رحمة خالد - من البطولات الرياضية إلى شاشة التلفزيون"
        />

        <p *ngIf="touchedInvalid('title')" class="mt-1 text-[12px] font-bold text-red-600">
          العنوان مطلوب (على الأقل 3 أحرف).
        </p>
      </div>

      <!-- personName -->
      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">
          اسم الشخص <span class="text-red-600">*</span>
        </label>

        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="personName"
          placeholder="مثال: رحمة خالد"
        />

        <p *ngIf="touchedInvalid('personName')" class="mt-1 text-[12px] font-bold text-red-600">
          اسم الشخص مطلوب.
        </p>
      </div>

      <!-- domain -->
      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">المجال</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="domain"
          placeholder="مثال: إعلام/رياضة"
        />
      </div>

      <!-- country -->
      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">الدولة</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="country"
          placeholder="مثال: مصر"
        />
      </div>

      <!-- highlight -->
      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">ملخص قصير (Highlight)</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="highlight"
          placeholder="مثال: قصة ملهمة عن الإصرار والدمج"
        />
      </div>

      <!-- cover -->
      <div class="md:col-span-2">
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">رابط صورة الغلاف</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="coverImageUrl"
          placeholder="https://..."
        />
        <p class="mt-1 text-[12px] font-bold text-stone-500">يمكن تركه فارغًا وسيظهر Placeholder.</p>
      </div>

      <!-- summary (TextareaModule) -->
      <div class="md:col-span-2">
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">
          القصة (Summary) <span class="text-red-600">*</span>
        </label>

        <textarea
          pInputTextarea
          autoResize="true"
          rows="5"
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="summary"
          placeholder="اكتبي القصة هنا بشكل مختصر وواضح..."
        ></textarea>

        <p *ngIf="touchedInvalid('summary')" class="mt-1 text-[12px] font-bold text-red-600">
          النص مطلوب (على الأقل 10 أحرف).
        </p>
      </div>

      <!-- tags -->
      <div class="md:col-span-2">
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">Tags (CSV)</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="tagsCsv"
          placeholder="مثال: متلازمة داون,مصر,إلهام"
        />
      </div>
    </div>

    <!-- media section -->
    <div class="mt-6 rounded-3xl border border-black/10 bg-white/70 p-4 backdrop-blur">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h3 class="text-[15px] font-extrabold text-stone-900 m-0">وسائط (Media)</h3>
          <p class="mt-1 text-[12px] font-bold text-stone-600">
            أضيفي صورة/فيديو/رابط — لو url فاضي لن يتم إرساله.
          </p>
        </div>

        <button
          type="button"
          pButton
          icon="pi pi-plus"
          label="إضافة وسيط"
          class="p-button-rounded"
          (click)="addMedia()"
        ></button>
      </div>

      <div class="mt-4 space-y-3" formArrayName="media">
        <div
          class="grid gap-3 rounded-2xl border border-black/10 bg-white p-4 md:grid-cols-12"
          *ngFor="let g of mediaArr.controls; let i = index"
          [formGroupName]="i"
        >
          <!-- kind (SelectModule / DropdownModule) -->
          <div class="md:col-span-3">
            <label class="mb-1 block text-[12px] font-extrabold text-stone-700">النوع</label>
            <p-select    [options]="mediaKinds"
              optionLabel="label"
              optionValue="value"
              placeholder="اختاري"
              formControlName="kind"
              styleClass="w-full"
              panelStyleClass="rounded-xl" />
      
          </div>

          <div class="md:col-span-4">
            <label class="mb-1 block text-[12px] font-extrabold text-stone-700">العنوان</label>
            <input
              pInputText
              class="w-full rounded-2xl px-3 py-3 text-[13px] font-bold"
              formControlName="title"
              placeholder="مثال: فيديو ملهم"
            />
          </div>

          <div class="md:col-span-4">
            <label class="mb-1 block text-[12px] font-extrabold text-stone-700">الرابط (URL)</label>
            <input
              pInputText
              class="w-full rounded-2xl px-3 py-3 text-[13px] font-bold"
              formControlName="url"
              placeholder="https://..."
            />
          </div>

          <div class="md:col-span-1 flex items-end">
            <button
              type="button"
              pButton
              icon="pi pi-trash"
              class="p-button-rounded p-button-text"
              (click)="removeMedia(i)"
              [disabled]="mediaArr.length === 1"
              title="حذف"
            ></button>
          </div>
        </div>
      </div>
    </div>

    <!-- submitter -->
    <div class="mt-6 grid gap-4 md:grid-cols-2">
      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">اسم المُرسل</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="submittedByName"
          placeholder="اختياري"
        />
      </div>

      <div>
        <label class="mb-1 block text-[13px] font-extrabold text-stone-800">بريد المُرسل</label>
        <input
          pInputText
          class="w-full rounded-2xl px-4 py-3 text-[14px] font-bold"
          formControlName="submittedByEmail"
          placeholder="name@email.com"
        />

        <p
          *ngIf="c('submittedByEmail')?.touched && c('submittedByEmail')?.invalid"
          class="mt-1 text-[12px] font-bold text-red-600"
        >
          البريد غير صحيح.
        </p>
      </div>
    </div>

    <!-- actions -->
    <div class="mt-7 flex flex-col-reverse gap-3 md:flex-row md:items-center md:justify-between">
      <button
        type="button"
        pButton
        label="مسح البيانات"
        class="p-button-rounded p-button-outlined"
        (click)="resetForm()"
        [disabled]="saving"
      ></button>

      <button
        type="submit"
        pButton
        [label]="saving ? 'جاري الإرسال...' : 'إرسال القصة'"
        icon="pi pi-send"
        class="p-button-rounded"
        [loading]="saving"
        [disabled]="saving"
      ></button>
    </div>
  </form>
</p-dialog>
